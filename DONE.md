# DONE

- [2026-02-14] Verbatim source code in trace report + expandable asserts. Threaded `source_text` through `CodegenContext` with `source_line(span)` helper to extract source at any span. All trace events now include `"src"` field with verbatim Gorget source (e.g., `"src":"if n <= 1"`, `"src":"auto total = 0"`, `"src":"assert factorial(5) == 120"`). Added `__gorget_trace_json_str` C runtime helper for JSON-safe string output. Assert statements now emit `assert_start`/`assert_end` pairs that bracket condition evaluation at depth+1, making function calls within assertions expandable in the HTML report. Report updated: new `AssertStart`/`AssertEnd` event types, `src` field on `Stmt`/`Branch`, source text rendered as primary label with monospace styling, assert nodes expandable like call nodes. 4 new unit tests. Housekeeping: tracked `test_traced.gg` fixture, added .gitignore entries for build artifacts, recorded string return trace UB bug in TODO.md. All 309 unit + 164 integration tests pass.
- [2026-02-14] Statement-level tracing + tree-structured HTML report. Codegen: added trace events for VarDecl (let), Assign, CompoundAssign, Assert, and If/Elif/Else branches in `c_stmt.rs`, all guarded by `self.trace`. Extracted `emit_trace_assign` helper. Report: added `Stmt` and `Branch` variants to `TraceEvent`, stack-based `build_tree()` algorithm that pairs Call/Return events into parent-child trees and groups Loop iterations with their body events, recursive `render_tree_html()` for expand/collapse tree rendering. Updated CSS with tree-specific styles (`.tree-row`, `.tree-children`, `.tree-toggle`) and new event type colors (stmt, branch, var, literal). Added `ttoggle()` JS for nested tree expansion. 10 new unit tests (parse_stmt_event, parse_stmt_assign, parse_stmt_assert, parse_branch_event, parse_branch_else, build_tree_call_return_pair, build_tree_nested_calls, build_tree_loop_groups_children, build_tree_flat_stmts). Updated `trace_directive` integration test for new event count. All 306 unit + 160 integration tests pass.
- [2026-02-14] Vector batch 2 methods: `.index_of(x)`, `.insert(i, x)`, `.extend(other)`, `.slice(i, j)`, `.any(fn)`, `.all(fn)`. Added C runtime helpers `gorget_array_index_of`, `gorget_array_insert`, `gorget_array_extend` (slice already existed). Semantic + codegen + `builtin_method_return_type` wiring. New fixture `vector_methods2.gg`. All 309 unit + 165 integration tests pass.
- [2026-02-14] High-priority built-in type methods: Vector `.sort()`, `.sorted()`, `.reverse()`, `.contains()`; Dict `.keys()`, `.values()`, `.items()`; Set `.union()`, `.intersection()`, `.difference()`. Added C runtime sort comparators (`__gorget_cmp_i64/f64/str/char/bool`) and `gorget_array_reverse()`. Semantic type registration in `builtin_method_type()`. Codegen for all methods in `gen_vector_method/gen_map_method/gen_set_method`. Late-registered tuple typedefs (from Dict.items()) now splice before function definitions. 4 new integration tests: `vector_sort.gg`, `dict_keys_values.gg`, `dict_items.gg`, `set_operations.gg`. All 285 unit + 162 integration tests pass.
- [2026-02-14] Vector higher-order methods: `.map()`, `.filter()`, `.reduce()` — implemented as part of higher-order collection methods with closure-based functional operations, type inference, and C codegen. Integration tests passing.
- [2026-02-14] HTML report generation from trace data: `gg report <file>.trace.jsonl` standalone subcommand and `gg test --report html` convenience flag (auto-enables `--trace`). Self-contained HTML with inline CSS/JS: pass/fail summary with pass-rate bar, test table with status badges and durations, expandable per-test function call traces. Hand-rolled JSONL parser (no serde dependency) for `test_start`/`test_end`/`call`/`return`/`loop` events. Fixed positional filename parsing to skip known flag values (`--report`, `--tag`, etc.). New module `src/report.rs` with 12 unit tests. 2 integration tests (`test_report_subcommand`, `test_report_flag_on_test`). Documented in language-reference.md §18.7.
- [2026-02-14] `--trace` integration for test runs: wired `--trace`/`--no-trace` CLI flags through `gg test` (was hardcoded to `false`). Test runner now emits `test_start` and `test_end` JSONL events with test name, status (pass/fail), and duration_ms — interleaved with function-level trace events. Trace init added to test runner main(). All 6 pass/fail branches (normal, @should_panic bare, @should_panic with message) emit `test_end`. New integration test `trace_in_test_mode`. Documented in language-reference.md §18.7. All 285 unit + 157 integration tests pass.
- [2026-02-14] Add Python-style `.strip()`, `.lstrip()`, `.rstrip()` string methods with optional `chars` argument. No-arg versions strip whitespace; with a `chars` string they strip any character in that set (Python semantics). Added 5 C runtime helpers, codegen dispatch for all 3 methods (with and without args), semantic type registration, `builtin_method_return_type` entries, documentation in language-reference.md, and integration test `string_strip.gg`. All 285 unit + 157 integration tests pass.
- [2026-02-14] Test Framework Phase 2: four features. (1) `--filter <substr>` name-based test filtering — only runs tests whose name contains the substring. (2) `--exclude-tag <tag>` — skips tests with the excluded tag; exclusion wins over inclusion when both `--tag` and `--exclude-tag` match. (3) Console reporter improvements — `Running N tests...` header with compile-time test count, per-test and total duration in milliseconds via `clock_gettime(CLOCK_MONOTONIC)`. (4) `@should_panic` test attribute — inverts pass/fail logic; optional string argument for panic message substring matching. Renamed `test_matches_tag` → `should_run_test` with combined name/exclude/include filtering. New fixture `test_should_panic.gg`. 7 new integration tests. Updated language-reference.md §18 with new sections for name filtering, `@should_panic`, and console output. All 285 unit + 156 integration tests pass.
- [2026-02-14] Consolidate process execution into `std.process`: moved `exec(str) -> int` from `std.os` and `run_output` from `std.test.process` into new `std.process` module. Renamed `ProcessResult` → `ExecResult`, `run_output` → `exec_output`. Removed redundant `run` (duplicate of `exec`). Removed `std.test.process` entirely. Updated C runtime (`PROCESS_RUNTIME`), codegen dispatch, fixtures (`exec_builtin.gg`, `test_process.gg`), and language reference (§15.3, §18.4). All 285 unit + 150 integration tests pass.
- [2026-02-14] Document built-in traits in language reference: new §15.1 Built-in Traits covering all 6 core traits (Displayable, Equatable, Hashable, Cloneable, Drop, Iterator[T]) with signatures, compiler features they enable, and usage examples. Also documents trait features (default methods, inheritance, `via` delegation). Reordered §15 subsections: 15.1 Built-in Traits (new), 15.2 Built-in Type Methods (renumbered), 15.3 Standard Library Modules (renumbered).
- [2026-02-14] Allow test blocks and main() to coexist: `gg build`/`gg run` uses main() and strips test code; `gg test` uses the test runner and ignores main(). Removed `TestMainConflict` semantic error. Changed codegen from auto-detecting `is_test_module` from file contents to receiving `test_mode: bool` from the CLI command. Semantic analysis still checks all code regardless of mode. New fixture: `test_coexist.gg` with 2 integration tests (build mode + test mode). All 285 unit + 150 integration tests pass.
- [2026-02-14] `with` clause on test blocks: per-test resource management with automatic teardown. Syntax: `test "name" with expr as var:` (single) or `test "name" with expr as a, expr as b:` (multiple). Resources created before test body, dropped automatically after (even on assertion failure via longjmp cleanup stack). AST: added `with_bindings: Vec<WithBinding>` to `TestDef`. Parser: `parse_test_def` parses optional `with` clause; fixed `parse_with_stmt` to use `decompose_as_binding` (shared helper that decomposes `Expr::As` back into with-binding, since `as` is the highest-precedence infix operator). Semantic: resolve/typecheck/borrow-check with-binding expressions and define variable names. Codegen: emit with-binding declarations inside drop scope + setjmp block, register Drop cleanup. New fixture: `test_with_clause.gg`. 2 parser unit tests + 1 integration test. All 285 unit + 148 integration tests pass.
- [2026-02-14] Fix longjmp in test mode skipping drop-scope cleanup: added runtime cleanup stack (`__gorget_cleanup_push`/`__gorget_cleanup_run`) that survives `longjmp`; droppable variables (Box, File, user Drop) register into the cleanup stack when `in_test_body` is true; test runner saves cleanup mark before `setjmp`, resets it on normal path, runs cleanup on failure path; new `in_test_body` flag on CodegenContext; `maybe_register_droppable` now takes emitter and emits cleanup registration; new fixture `test_cleanup.gg` + integration test. All 283 unit + 148 integration tests pass.
- [2026-02-13] Assert diagnostics: bare `assert x == 42` now shows actual values on failure (`assertion failed: left == right\n  left:  1\n  right: 2`). Works for all comparison ops (==, !=, <, >, <=, >=) on any formattable type. Custom message asserts unchanged. Added `comparison_op_str` helper and `gen_assert_diagnostic` method in `c_stmt.rs`, made `format_for_type_id` pub(super) in `c_expr.rs`, updated `test_failure` integration test.
- [2026-02-13] Test Automation Framework Phase 1: built-in `test` blocks, `suite setup`/`teardown`, `gg test` CLI command, `@tag` filtering, `std.test.process` module. Lexer: `test`/`suite` keywords. Parser: `test "name":` blocks, `suite setup/teardown:` blocks, `expect_plain_string()` helper. AST: `TestDef`, `SuiteSetup`, `SuiteTeardown` structs + `Item` variants. Semantic: test/main conflict validation, duplicate suite block detection, resolve/typecheck/borrow-check test bodies. Codegen: runtime split (`RUNTIME_PREAMBLE`/`PANIC_NORMAL`/`PANIC_TEST`/`RUNTIME_CORE`), `setjmp`/`longjmp` test recovery, `emit_test_runner_main()` generates C `main()` with per-test execution and pass/fail counting. `std.test.process`: `ProcessResult` struct (`output`, `errors`, `exit_code`), `run(cmd) -> int`, `run_output(cmd) -> ProcessResult` via `popen`. Formatter: test/suite formatting. CLI: `gg test <file> [--tag <tag>]`. 5 integration tests + 5 parser unit tests. All 283 unit + 146 integration tests pass.
- [2026-02-13] Add 6 remaining string methods: `substring(start, end)`, `char_at(index)`, `index_of(needle)`, `count(needle)`, `repeat(n)`, `join(parts)`. Also added `builtin_method_return_type` entries so `print()` correctly formats return values. New C runtime helpers: `gorget_string_index_of`, `gorget_string_count`, `gorget_string_repeat`, `gorget_string_join`. New fixture: `string_methods2.gg`.
- [2026-02-13] Implement `directive trace` execution tracing: opt-in JSONL trace output (`<binary>.trace.jsonl`) recording function calls/returns with args, values, and depth. Enabled via `directive trace` in source or `--trace` CLI flag; `--no-trace` overrides. Zero overhead when disabled (no extra code emitted). Traces show Gorget names/types (not C-mangled). Includes function entry/exit tracing, loop iteration tracing (for/while), implicit void returns. Modified: semantic/mod.rs, main.rs, codegen/{mod,c_runtime,c_item,c_stmt,c_types}.rs. New fixture: trace_test.gg. 3 new integration tests.
- [2026-02-13] Implement `via` delegation in equip blocks: `equip Type with Trait via field:` auto-forwards unimplemented trait methods through a struct field. Added `Via` keyword, `via_field` on EquipBlock AST, semantic validation (field exists, field type implements trait), codegen forwarding functions, `pass` support in equip blocks, formatter roundtrip. New fixture `via_delegation.gg`, 4 unit tests.
- [2026-02-13] Close scan_for_generics/scan_for_tuples duplication as accepted — added comment explaining the decision (abstraction cost outweighs savings for stable, mechanical walkers)
- [2026-02-13] Complete remaining stdlib items: `rand_range(lo, hi)` in std.random; `setenv`, `getcwd`, `platform` in std.os; `time_ms` (millisecond-precision via `clock_gettime`) in std.time; `std.fmt` module (empty — Displayable/format already in prelude, module exists for discoverability). New fixtures: random_stdlib.gg, os_stdlib.gg, time_stdlib.gg
- [2026-02-13] Expand `std.conv` with 5 new functions: `parse_float(str) -> float`, `int_to_str(int) -> str`, `float_to_str(float) -> str` (compact `%g` format), `bool_to_str(bool) -> str`, `char_to_str(char) -> str`; C runtime uses `strtod` for parse_float, `snprintf` for numeric-to-string; new fixture `conv_stdlib.gg`
- [2026-02-13] Add `input(str) -> str` and `readline() -> str` to `std.io`: `input` prints a prompt and reads a line from stdin (like Python's `input()`), `readline` reads a line with no prompt; C runtime uses `fgets` with newline stripping; new `run_gg_with_stdin` test helper for piping stdin in integration tests; new fixture `io_input.gg`
- [2026-02-13] Add `std.math` stdlib module: 21 functions wrapping `<math.h>` — integer (`abs`, `min`, `max`), float (`sqrt`, `pow`, `floor`, `ceil`, `round`, `log`, `log2`, `log10`, `sin`, `cos`, `tan`, `asin`, `acos`, `atan`, `atan2`, `fabs`, `fmin`, `fmax`); added `#include <math.h>` to runtime, synthetic module in stdlib.rs, codegen dispatch in c_expr.rs; new integration test `math_stdlib.gg`; documented in language-reference.md §15.1
- [2026-02-13] Fix closure env memory leak: replace heap-allocated env (malloc) with C99 compound literal for stack allocation. Env now has automatic storage duration tied to the enclosing block — no malloc, no free needed. Escaping closures (returned/stored) are undefined, matching Rust's borrow semantics; long-term fix (Rust-model closures with embedded captures) added to TODO.
- [2026-02-13] Add cycle detection to `collect_all_trait_methods` (c_item.rs): thread `visited: HashSet<String>` through recursion to prevent infinite loop on cyclic `extends` chains; skip tuple_typedefs dedup item as accepted (linear scan over <30 entries is fine, added comment)
- [2026-02-13] Replace generic_instances.clone() with index-based loops in emit_generic_type_definitions and emit_generic_method_definitions (c_item.rs) — avoids cloning entire Vec on every compilation
- [2026-02-13] Unify for-loop codegen: merged 6 functions (`gen_for_loop`, `gen_for_loop_with_else`, `gen_for_loop_iterator`, `gen_for_loop_iterator_with_else`, `gen_for_loop_dict`, `gen_for_loop_set`) into a single `gen_for_loop` taking `else_body: &Option<Block>`. Removed ~280 lines of duplicated code. All 7 iterable kinds (range, string, array, map, set, iterator, C-array) share common body/close/else logic.
- [2026-02-13] Prefix user-defined function names with `gg_` in C output to prevent collisions with C library symbols (e.g. `send` vs `sys/socket.h`): added `escape_function()` to c_mangle.rs for `gg_` prefix, `function_names: HashSet<String>` to CodegenContext populated from module items, used in `function_signature()` for definitions and `gen_expr` Identifier for call sites; variables, struct fields, and parameters keep bare names (scoped in C, no collision risk); `escape_keyword()` reverted to C-keyword-only escaping
- [2026-02-13] Trim `is_builtin()` to just `print | format | len | type`: removed dead builtins `range`, `enumerate`, `zip`, `map`, `filter` which had zero usage and zero codegen support
- [2026-02-13] Move collection types to `std.collections`: added `gen_collections_module()` to `src/stdlib.rs` with dummy `StructDef` items for Vector, List, Array, Dict, HashMap, Map, Set, HashSet, Box, File; stripped `is_builtin()` to 9 compiler intrinsics (print, format, len, range, enumerate, zip, map, filter, type); removed collection type pre-registration from `collect_top_level()` in resolve.rs; added `from std.collections import ...` to 28 fixtures and 16 example files; traits (Displayable, etc.) and Option/Result remain implicit prelude; 272 unit tests + 130 integration tests pass
- [2026-02-13] Add interactive I/O stdlib modules (`std.random`: rand/seed, `std.time`: time/sleep_ms, `std.io`: getchar) with C runtime wrappers; console Snake game example (`examples/snake.gg`) demonstrating enums, structs, vectors, mutable borrow params, pattern matching, game loop, ANSI terminal control; integration test `builtins_interactive.gg`; documented all 7 stdlib modules in language-reference.md §15.1
- [2026-02-13] Consolidate print builtins into Python-style `print()`: removed `println`/`eprint`/`eprintln` builtins; `print()` now supports `file=stderr` kwarg (for stderr output) and `newline=false` kwarg (to suppress trailing newline); added `std.io` virtual stdlib module with `stderr`/`stdout` static constants that map to C stdio macros; usage: `from std.io import stderr` then `print("msg", file=stderr)`; renamed `eprint_builtin.gg` fixture to `print_builtin.gg`; all 269 unit tests + 129 integration tests pass
- [2026-02-13] Stdlib module system: moved 18 hardcoded builtins behind `from std.* import ...` imports across 4 virtual modules (`std.fs`: read_file/write_file/append_file/file_exists/delete_file, `std.path`: path_join/path_parent/path_basename/path_extension/path_stem, `std.os`: exec/exit/getenv/args/readdir, `std.conv`: ord/chr/parse_int); new `src/stdlib.rs` generates synthetic Module ASTs with `FunctionBody::Declaration` + `Span::dummy()`; loader intercepts `std.*` imports before filesystem resolution; `is_stdlib_call()` guard in codegen prevents user-defined functions from being hijacked by builtin dispatch; removed hardcoded return types from `resolve_expr_type_id`/`infer_c_type_from_expr` (stdlib functions now resolved via `function_info`); 6 fixtures updated with imports; `result_question.gg` regression confirmed (user-defined `parse_int` still works without importing stdlib)
- [2026-02-13] Self-hosting builtins batch 2: `exec(cmd) -> int` (subprocess via `system()`), `exit(code)` (process termination), `eprint`/`eprintln` (stderr output via `fprintf(stderr,...)`), `parse_int(str) -> int` (string-to-int via `strtoll`), `getenv(name) -> str` (environment variable lookup), `ord(char) -> int` / `chr(int) -> char` (char↔int conversions), char classification methods `.is_alpha()`, `.is_digit()`, `.is_alphanumeric()`, `.is_whitespace()` (via `<ctype.h>`); refactored `gen_printf_from_string_lit` to accept optional stream param for stdout/stderr reuse; added user-defined function shadowing check for `parse_int` builtin; 3 new integration tests (exec_builtin, eprint_builtin, char_methods)
- [2026-02-13] Self-hosting blocker builtins: `path_join`, `path_parent`, `path_basename`, `path_extension`, `path_stem` (path manipulation), `readdir` (directory listing → Vector[str]), `args` (CLI argument access → Vector[str]); changed `main()` signature from `int main(void)` to `int main(int argc, char** argv)` with `gorget_init_args` call; added `#include <dirent.h>` to runtime; also fixed: string `==`/`!=` now uses `strcmp` instead of pointer comparison, `Expr::Index` type resolution for Vector element types, builtin return type inference in `resolve_expr_type_id` and `infer_c_type_from_expr` (path/file/readdir/args); 3 new integration tests (path_funcs, readdir, cli_args)
- [2026-02-13] `@derive(Displayable, Equatable, Hashable)` for generic enums: three fixes — (1) derive macro now emits `equip [T] Wrapper[T]` syntax (generic params before type name) so parser populates `generic_params` on the EquipBlock AST, (2) typecheck.rs pushes a scope with GenericParam defs for generic equip blocks in both pre-pass and main pass so `T` resolves correctly in `ast_type_to_resolved`, (3) skip Displayable check for GenericParam types in string interpolation; also fixed 3 codegen issues: `type_id_to_c_substituted` helper applies `type_subs` mapping for GenericParam TypeIds — used in `resolve_enum_c_type_for_scrutinee` (enum tags), `format_for_type_id` (string interpolation), `infer_receiver_mangled_type` and `infer_receiver_c_type` (method dispatch); added `format_for_c_type` in c_types.rs for C-type-to-printf mapping
- [2026-02-13] Mutable borrow parameters in free functions: `Type &name` params in non-method free functions now emit `Type*` pointer parameters in C, with `(*name)` dereference for identifier reads, `name->field` for field access, and `&arg` wrapping at call sites; also handles method calls on pointer params (pass pointer directly instead of `&(*name)`), string interpolation dereference, and generic method/equip block pointer params; integration test `mutable_borrow_params.gg` with increment, reset, swap_values free functions
- [2026-02-13] `@derive` for generic structs/enums: type parameter forwarding in generated equip blocks (`equip Pair[T] with Equatable:` instead of `equip Pair with Equatable:`); added `format_generic_params()` helper + `gs` parameter through all 8 derive generators; fixed 5 codegen issues for generic trait equip blocks: (1) `is_generic_equip()` now checks enum templates too, (2) `discover_generic_usages()` skips generic equip blocks to prevent spurious template instantiations, (3) `emit_vtable_instances()` skips generic equip blocks, (4) `emit_generic_method_definitions()` handles both struct and enum equip blocks, (5) trait method call sites use mangled type names via new `infer_receiver_mangled_type()` helper; also fixed `resolve_enum_c_type_for_scrutinee()` for `SelfExpr` and variant constructor resolution in monomorphized method bodies; struct Equatable/Displayable/Cloneable/Hashable all work for generic structs; enum Cloneable works for generic enums (Displayable/Equatable/Hashable blocked by separate semantic issue with pattern binding type resolution)
- [2026-02-13] `@derive(Cloneable)` for enums: generates `clone()` method via match on self with variant reconstruction (unit variants return bare constructor, tuple variants bind and reconstruct fields); mirrors existing enum derive pattern (Equatable, Displayable, Hashable)
- [2026-02-13] ECS battle simulation showcase (`examples/ecs/`): reusable ECS library with `EntityPool` (ID allocation + recycling via free list) and `SparseSet[T]` (generic sparse set container with O(1) insert/remove/lookup using swap-and-pop), turn-based battle game with `World` struct composing EntityPool + 4 SparseSets (health, attacks, teams, names), combat system targeting highest-HP enemy with tie-break on lowest ID, dead entity cleanup; demonstrates generic structs with equip blocks, multi-file modules, `@derive(Displayable)`, `&self` mutation
- [2026-02-13] Generic equip block monomorphization in codegen: `equip SparseSet[T]:` methods now correctly monomorphized for each concrete instantiation (e.g. `SparseSet__Health__insert`); added `generic_equip_templates` storage, forward declarations for generic struct instantiations, split emission into type definitions (before user types) and method definitions (after), type substitution in method bodies, `infer_receiver_type` fallback from mangled to base name for field lookups
- [2026-02-13] `@derive(Hashable)` for structs and enums: built-in `.hash()` method on all primitive types (int/float/bool/char/str) via `__gorget_fnv1a`/`__gorget_hash_str` runtime functions; wired into `builtin_method_type` (semantic), `try_gen_builtin_method`/`gen_string_method`/`builtin_method_return_type` (codegen); struct derive combines field hashes via `h *% 31 +% field.hash()` (wrapping arithmetic); enum derive hashes variant index + fields via match; also fixed `SelfExpr` typing in typecheck — added `current_self_type` field to TypeChecker, set from equip block target type, so `match self:` pattern bindings get correct type_ids for codegen dispatch
- [2026-02-13] `@derive` macro expansion: `@derive(Equatable, Displayable, Cloneable)` on structs and `@derive(Equatable, Displayable)` on enums auto-generates equip blocks with correct method bodies; template expansion approach generates Gorget source, parses it, and splices EquipBlock AST nodes before semantic analysis; struct Equatable (field-by-field ==), Displayable (format("Type(f1={self.f1},...)")), Cloneable (constructor copy); enum Equatable (nested match on tag + fields), Displayable (match on tag with field formatting); UnderivableTrait error for invalid derives; also fixed two codegen bugs: (1) match on `self` in enum methods now dereferences the self pointer, (2) match arm block bodies now generate statements directly instead of wrapping in GCC statement expressions
- [2026-02-12] Closure mutable reference captures: closures that assign to captured variables now capture them by mutable reference (pointer) so mutations propagate to the outer scope; added CaptureMode enum (ByValue/ByMutRef), mutation detection via AST walk, `(*__env->var)` codegen for ByMutRef reads/writes, `TYPE*` in env struct with `&var` population; also fixed `walk_free_vars` to handle Block/Match/TupleFieldAccess/nested Closure/StringInterpolation and added `walk_free_vars_in_stmt` for full statement-level recursion; fixed `stmt_to_inline_string` for CompoundAssign, `infer_c_type_from_expr` for Block/Do void inference, and void-returning lifted closure emission
- [2026-02-12] Closure parameter type inference: untyped closure params like `(a, b): a + b` now infer types from calling context; typecheck writes fresh type vars to DefInfo for untyped params, finalization pass with deep resolution walks composite types (Function, etc.) to replace all type vars with concrete types before substitution map is dropped, codegen looks up inferred types from DefInfo when AST annotation is missing
- [2026-02-12] Refactor codegen to `&mut self`: removed all `RefCell` wrappers from `CodegenContext` fields (13 fields), changed ~80 method signatures from `&self` to `&mut self` across c_item.rs/c_expr.rs/c_stmt.rs, replaced all `.borrow()`/`.borrow_mut()` calls with direct field access; fixes 2 borrow-checker conflicts via `.cloned()` on `field_type_names.get()` before calling `ast_type_to_type_id`; eliminates runtime overhead of RefCell and makes mutation explicit in the type system
- [2026-02-12] Fix Deref type inference and cross-module span collision in semantic analysis: (1) `Expr::Deref` in typecheck.rs now unwraps `Box[T]` → `T` instead of returning `Box[T]` unchanged — was masked in single-file mode because variant constructors resolved to error_id, but exposed in multi-module mode where function signatures are fully registered; (2) added `resolve_name()` helper to typecheck.rs with name-validation guards on all 8 `resolution_map.get()` sites, matching the codegen fix; fixes `examples/calculator/main.gg` regression
- [2026-02-12] Multi-file pipeline showcase (`examples/pipeline/`): Student struct with Displayable, reusable stats functions (sum via fold, max/min/count via for-loops), data processing pipeline with filter/map/fold on Vector[Student], cross-module imports; also fixed cross-module span collision bug in codegen: resolution_map keyed by `span.start` (byte offset) collides when merged modules have overlapping file-relative offsets — added name-validation guards to all 5 `resolution_map.get()` call sites in c_expr.rs so collisions fall through to `lookup_by_name_anywhere` fallback
- [2026-02-12] Pattern-bound variable type inference in match: `assign_pattern_types` in typecheck.rs propagates scrutinee type through patterns to assign type_ids to bindings; handles built-in Option/Result generics, user-defined enums (with generic substitution via `variant_field_types` on `EnumVariantInfo`), tuples, and or-patterns; `print("{e}")` in `case Error(e):` for `Result[int, str]` now correctly prints strings instead of garbage `%lld` output; updated `match_option_result.gg` to test `Result[int, str]`
- [2026-02-12] Multi-file todo_app showcase (`examples/todo_app/`): Task struct with Displayable trait, Priority enum, TaskStore wrapping `Vector[Task]` with filter/count methods; demonstrates Vector of user-defined structs, closures with struct types in filter, `&self` mutation, cross-module trait equip, format() with field access; required fixing `infer_vector_elem_type` to extract element type from AST field annotations when `resolve_expr_type_id` can't resolve generic field types like `Vector[Task]`
- [2026-02-12] Multi-file calculator showcase (`examples/calculator/`): recursive `Expr` enum with `Box[Expr]` payloads (Num, Add, Mul, Neg), recursive `eval()` using match destructuring + Box dereference, helper functions with expression-body syntax, cross-module imports; required fixing two codegen bugs: (1) `box_inner_c_type` now uses `resolve_expr_type_id` for reliable type resolution instead of falling back to `int64_t`, (2) `Expr::Deref` handler always emits C dereference `(*inner)` since Gorget `*` is exclusively Box dereference
- [2026-02-12] Multi-file shapes showcase (`examples/shapes/`): Shape trait in `shape.gg`, Circle and Rect structs in separate modules with cross-module `equip ... with Shape`, inherent methods (circumference, is_square), Box[Shape] dynamic dispatch in `main.gg`; demonstrates traits, modules/imports, struct methods, vtable dispatch, string interpolation
- [2026-02-12] Match on generic enum variants (`case Some(x):` for `Option[int]`, `case Ok(v):`/`case Error(e):` for `Result[int,int]`, `is Some`/`is None`): fixed tag constant names in `pattern_to_condition` (c_stmt.rs) and `pattern_to_condition_expr` (c_expr.rs) to use monomorphized enum names (e.g. `Option__int64_t_TAG_Some`) instead of raw names (`Option_TAG_Some`); added `resolve_enum_c_type_for_scrutinee()` helper to resolve scrutinee type to mangled C name via `ResolvedType::Generic`; also fixed `Pattern::Literal(NoneLiteral)` to generate tag checks instead of `== NULL` when matching on Option enums; integration test `match_option_result.gg`
- [2026-02-12] Nested generics (`Vector[Vector[int]]`, `Option[Vector[int]]`, `Dict[str, Vector[int]]`): structural unification in `unify()` for Generic/Tuple/Array/Slice/Function types (was failing because fresh TypeIds for structurally identical compound types didn't match); recursive generic arg scanning in `scan_type_for_generics()` to register nested instantiations; improved `display()` and `describe_resolved_type()` to show generic args in error messages; integration test `nested_generics.gg`
- [2026-02-12] Implement automatic `Box[Trait]` dispatch: semantic resolves `Box[Trait]` to `ResolvedType::TraitObject` (added `DefKind::Trait` to allowed types in `ast_type_to_resolved`), codegen detects `Box[Trait]` patterns in `extract_trait_object_construction` for trait object construction (`{.data=..., .vtable=&vtable}`), vtable dispatch via `recv.vtable->method(recv.data)` in `gen_method_call`, `TraitObjFree` drop action (`free(.data)`), `ast_type_to_c` maps `Box[Trait]` to `Trait_TraitObj`; updated `dynamic_dispatch.gg` fixture to exercise both direct and vtable dispatch
- [2026-02-12] Remove `dynamic` keyword from compiler source: lexer (Keyword::Dynamic variant, from_str, Display), parser (Type::Dynamic AST variant, parse_type prefix, is_type_start), semantic (ast_type_to_resolved Dynamic arm), codegen (ast_type_to_c Dynamic arms, Box[dynamic Trait] special cases, extract_trait_object_construction, 3 unit tests), formatter (Type::Dynamic arm). Internal dispatch machinery (ResolvedType::TraitObject, vtable codegen, equip-based dispatch) preserved.
- [2026-02-11] Fix struct `str` field interpolation printing pointer address: extended `resolve_field_type` to handle struct fields via `field_type_names` map, added `ast_type_to_type_id` helper to convert AST types to semantic TypeIds, added `FieldAccess` arm to `resolve_expr_type_id`; `{msg.sender}` now correctly prints string content; removed local variable workarounds in ownership example and fixture
- [2026-02-11] Borrow checker showcase: `examples/ownership.gg` (narrative example with message pipeline — borrow, mutable borrow via method, move, reassignment revival, copy types), `tests/fixtures/ownership_showcase.gg` (integration test), README "Ownership & Borrowing" section in Language Tour; also discovered and recorded bug: struct `str` field interpolation prints pointer address instead of string content
- [2026-02-11] Curl-installable `gg` binary: GitHub Actions release workflow (cross-platform matrix: macOS ARM64/x86_64, Linux x86_64/ARM64 with musl), CI workflow (build + unit + integration tests on push/PR), `install.sh` POSIX script (platform detection, latest/pinned version, PATH setup), README Install section
- [2026-02-11] String concatenation (`+` and `+=` on strings): `gorget_str_concat()` C runtime helper, codegen special-cases `str + str` to call helper instead of arithmetic, `+=` on strings emits `s = gorget_str_concat(s, rhs)`, works with string interpolation (`"{a + b}"`), chaining (`"a" + "b" + "c"`), and literals
- [2026-02-11] `gg` script execution and interactive REPL: `gg script.gg` shorthand runs a .gg file directly (equivalent to `gg run`); `gg` with no args launches interactive REPL with `>>>` prompt, multi-line block support (`:` continuation), accumulated state (definitions placed before main, statements inside), marker-based incremental output, error recovery (failed code not added to buffer), `/reset`/`/show`/`/quit`/`/help` commands, Ctrl+D exit, temp dir cleanup; refactored `build()` into `try_build()` returning `Result<PathBuf, String>` for recoverable errors
- [2026-02-11] Codegen type inference consistency pass: extracted canonical `resolve_expr_type_id()` helper handling Identifier/literals/BinaryOp/UnaryOp/Call/MethodCall/Deref; refactored 10 functions in c_expr.rs and c_stmt.rs to use it; deleted 2 duplicate functions (`infer_array_elem_type`, `infer_map_kv_types_for_iter`); fixed `builtin_method_return_type` GorgetMap/GorgetSet prefix matching; simplified `infer_interp_expr_type` to delegate to helper; added MethodCall arm and fixed BinaryOp comparison operators in `infer_c_type_from_expr`
- [2026-02-11] Fix string interpolation of method calls: `infer_interp_expr_type()` now falls back to trait/inherent method lookup when builtin methods don't match, so `"{d.speak()}"` correctly emits `%s` instead of `%lld`
- [2026-02-11] Cross-module name resolution: deferred return type fixup pass in resolve.rs (re-resolves function return types after all imports are collected), function signature pre-registration in typecheck.rs (sets DefInfo.type_id to ResolvedType::Function before body checking so callers infer correct types), 5 new cross-module test fixtures (struct, enum, struct_return, trait, auto inference)
- [2026-02-11] Arena-backed linked list example (`examples/linked_list.gg` + `tests/fixtures/linked_list.gg`): parallel-vector arena with push_front, peek, length, reset, Iterator[int] impl, for-loop iteration, fold, map — exercises struct field indexing, &self mutation, Iterator trait, and iterator adapters
- [2026-02-11] Fix parser bug: `self.values[i]` (index after field access) — Dot handler now uses save/restore backtracking for `[` ambiguity (generic method vs indexing), matching the LBracket handler pattern; updated `struct_field_methods.gg` to use direct indexing instead of `.get(i)` workaround
- [2026-02-11] Fix struct field codegen bugs: `infer_receiver_type` now handles `FieldAccess` via `field_type_names` map (resolves `self.values.push(x)` → `Vector__push` instead of `Unknown__push`); `needs_temp` uses `is_lvalue()` helper to recognize field access chains as lvalues (fixes silent data loss from temporary copies); `infer_receiver_c_type` and `infer_c_type_from_expr` also handle `FieldAccess`; new `struct_field_methods.gg` integration test
- [2026-02-11] Iterator adapters: `.map()`, `.filter()`, `.collect()`, `.fold()` on any type implementing Iterator[T] — eager evaluation draining into Vector[T] (or scalar for fold), with typecheck inference and while/next/break codegen pattern
- [2026-02-11] `?` operator for Result[T,E] propagation: dual-mode `?` — on Result values, generates value-based early return (unwrap Ok or `return Error(e)`); falls back to existing setjmp/longjmp for throws-based error handling; typecheck records expr_types map for codegen, validates enclosing function returns Result, new TryOnResultInNonResultFunction error
- [2026-02-11] Vec capacity and slicing: `Vector[T](n)` with_capacity constructor, `.reserve(n)` method, `vec[i]` element indexing via `GORGET_ARRAY_AT`, `vec[start..end]` slicing via `gorget_array_slice()` — C runtime helpers, typecheck, codegen, integration test
- [2026-02-11] `directive immutable-by-default` + `mutable` keyword: three-tier immutability (const < plain < mutable), `mutable type name = expr` prefix syntax, const assignment enforcement (always), immutable variable enforcement (under directive), `is_mutable` tracked in AST/DefInfo/scope, borrow checker enforcement with AssignmentToImmutable/AssignmentToConst errors, formatter round-trip, integration tests, language reference docs
- [2026-02-11] `directive` system: per-file compilation options via `directive strip-asserts` and `directive overflow=wrap` — full pipeline: lexer keyword, parser (hyphenated names, key=value), AST node, semantic validation (UnknownDirective error), main.rs extraction with CLI flag OR-merge, formatter, integration tests, language reference docs
- [2026-02-11] Type-safe generic HashMap[K,V]: monomorphized Dict[K,V] into per-specialization C structs (e.g. `GorgetMap__const_char_ptr__int64_t`) with typed fields and inline functions; string keys use `__gorget_hash_str()` + `strcmp()` for correct content-based hashing; all methods (put/get/contains/remove/clear/filter/fold), constructors, for-loop iteration, dict comprehensions, and `in` operator updated to use monomorphized codegen
- [2026-02-11] `format(...)` built-in function: builds interpolated strings without printing, returns `const char*` (str) via `gorget_format()` C runtime helper, supports string interpolation and non-string value formatting
- [2026-02-11] String slicing, indexing, and iteration: `str[i]` returns char with bounds checking, `str[start..end]` returns substring via `gorget_string_slice()`, `for ch in string` iterates chars via strlen-based loop; typecheck infers char/str types, for-loop variable gets char TypeId for correct interpolation
- [2026-02-11] Wrapping operators `+%`/`-%`/`*%` and `+%=`/`-%=`/`*%=`: per-expression opt-out from overflow checking (Zig-style), full pipeline: 6 new lexer tokens, 3 BinaryOp variants, parser at same precedence as regular ops, typecheck, codegen emits plain C arithmetic (skips checked macros), formatter, integration test
- [2026-02-11] Integer overflow checking: `+`/`-`/`*` and `+=`/`-=`/`*=` now panic on signed integer overflow by default, using `_Generic` + `__builtin_*_overflow` intrinsics (float-safe via C11 `_Generic` dispatch); `--overflow=wrap` flag opts out with `-fwrapv` wrapping semantics
- [2026-02-11] Raw strings (`r"..."`) and multi-line strings (`"""..."""`): verified codegen handles both correctly (lexer already stores proper characters), added integration test coverage for raw strings (backslash preservation, no interpolation) and multi-line strings (embedded newlines)
- [2026-02-11] String stdlib methods: `contains`, `starts_with`, `ends_with`, `is_empty`, `trim`, `to_upper`, `to_lower`, `replace`, `split` — C runtime helpers, typecheck registration in `builtin_method_type()`, codegen in `gen_string_method()`, integration tests
- [2026-02-10] `assert` keyword: new statement `assert condition [, message]`, desugars to `if (!cond) gorget_panic(msg)`, always-on by default with `--strip-asserts` compiler flag; full pipeline: lexer keyword, parser, AST variant, name resolution, type checking, borrow checking, codegen, formatter, integration tests
- [2026-02-10] `in` operator codegen: `x in coll` desugars to `.contains()` calls for Vector (gorget_array_contains), Dict (gorget_map_contains), Set (gorget_set_contains), str (strstr); also added .contains() as a direct method on Vector and str
- [2026-02-10] Language design: added 3 readability/sugar features — string repetition (`"x" * 3`, via Mul[int] trait), `in` keyword for containment checks (desugars to Contains trait), multiple return values via tuple destructuring at call sites
- [2026-02-10] Language design: formalized 5 safety features in docs/language-design.md — integer overflow (panic by default, wrapping operators +%/-%/*%), bounds checking (language guarantee on arrays/slices/vectors), assert (always-on, never stripped), variable initialization (zero-init like Go, --require-init flag), Sendable/Syncable thread safety traits (auto-derived, unsafe equip for manual impl)
- [2026-02-10] Chained method calls on trait/inherent methods: `infer_receiver_type()` now handles `Expr::MethodCall` by recursively resolving receiver type and looking up method return type in TraitRegistry
- [2026-02-10] Named args / default params: parser already supported syntax; added FunctionInfo.param_defaults, semantic validation (named arg matching, ordering, duplicate/unknown/missing checks, PositionalAfterNamed error), codegen reordering and default value substitution
- [2026-02-10] Higher-order collection methods: Vector .filter()/.map()/.fold()/.reduce(), Dict .filter()/.fold(), Set .filter()/.fold() — closure-based functional operations with type inference and C codegen
- [2026-02-10] Iterator[T] trait: built-in trait with `next(&self) -> Option[T]` method, user types implement via `equip Foo with Iterator[int]`, for-loop integration emits while/next/break pattern, trait_generic_args tracked in EquipInfo, mutable self support for &self params
- [2026-02-10] Match exhaustiveness checking: semantic analysis rejects non-exhaustive enum matches with `NonExhaustiveMatch` error listing missing variants; handles constructors, or-patterns, wildcards, catch-all bindings, guards; skips non-enum types
- [2026-02-10] Runtime safety: bounds checking on Vector get/set/remove/pop (gorget_array_get, gorget_array_set, gorget_array_remove), division by zero guard on `/` and `%` operators — panics with clear error messages instead of UB
- [2026-02-10] Trait bounds enforcement: `where T is Trait` clauses now checked at generic call sites in semantic analysis, UnsatisfiedTraitBound error emitted when concrete type lacks required trait impl
- [2026-02-10] Generic function monomorphization: type substitutions now propagate into block bodies (local vars, casts, nested generic calls), added type_subs field to CodegenContext, type_to_c() convenience method
- [2026-02-10] File I/O: built-in File type with GorgetFile C runtime, free functions (read_file, write_file, append_file, file_exists), File struct (File.open, File.create, .read_all, .write, .close), Drop auto-close on scope exit
- [2026-02-10] `gg fmt` code formatter: lexer emits Comment tokens, parser side-tables them, AST-walking formatter with comment interleaving, --in-place flag, idempotency tested on all fixtures
- [2026-02-10] Default trait method resolution: codegen emits default method bodies when equip block doesn't override, vtable wiring, trait method call resolution for trait-provided methods
- [2026-02-10] Trait inheritance (extends) in vtables: child vtable structs include parent method slots, equip blocks validate and emit parent methods, semantic validation checks inherited required methods
- [2026-02-10] Drop trait / RAII (destructors): built-in Drop trait, scope-based cleanup at function/loop exit, Box[T] auto-free, user-defined Drop via equip, cleanup before return/break/continue
- [2026-02-10] Implicit `it` in closures: parser auto-wraps call args containing `it` in ImplicitClosure, typecheck assigns fresh type var to `it`, codegen delegates to existing closure machinery
- [2026-02-10] Box[T]: heap allocation wrapper (Box(v) and Box.new(v) constructors, .get()/.set() methods, *b deref, string interpolation, type inference)
- [2026-02-10] Core traits: Displayable, Equatable, Cloneable, Hashable — built-in trait registration, auto-hooks for ==/!= (Equatable) and string interpolation (Displayable), Self type resolution in equip blocks
- [2026-02-10] Iterator protocol: for-loop iteration over Dict and Set collections (key-only, key-value tuple, for-else support)
- [2026-02-10] Add `moving` and `mutable` keywords as ownership operator alternatives (both forms coexist with `!`/`&`)
- [2026-02-10] Option[T]/Result[T,E]: .map(), .and_then(), .or_else() with closure return type inference and non-capturing closure codegen
- [2026-02-10] Option[T] / Result[T,E] methods: unwrap, unwrap_or, is_some/is_none, is_ok/is_err (built-in type registration, typecheck, codegen, monomorphization)
- [2026-02-10] Collections: Vector[T], HashMap[K,V], HashSet[T] with real impls (set/remove/clear/is_empty methods, generic return types, C runtime support)
